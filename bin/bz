#!/bin/bash

set -euo pipefail

if [[ -n "${DEV:-}" ]]; then
  if [[ -f tools/bazel ]]; then
    BAZEL_REAL="$DOTFILES/../bazel/bazel-bin/src/bazel-dev" exec tools/bazel "$@"
  fi

  exec "$DOTFILES/../bazel/bazel-bin/src/bazel-dev" "$@"
fi

if [[ -n "${DEV2:-}" ]]; then
  if [[ -f tools/bazel ]]; then
    BAZEL_REAL="$DOTFILES/../bazel2/bazel-bin/src/bazel-dev" exec tools/bazel "$@"
  fi

  exec "$DOTFILES/../bazel2/bazel-bin/src/bazel-dev" "$@"
fi

if [[ -n "${DEVREL:-}" ]]; then
  if [[ -f tools/bazel ]]; then
    BAZEL_REAL="$DOTFILES/../bazel-rel/bazel-bin/src/bazel-dev" exec tools/bazel "$@"
  fi

  exec "$DOTFILES/../bazel-rel/bazel-bin/src/bazel-dev" "$@"
fi

bazelisk_bin=bazelisk
if [[ "$1" == -x86 ]]; then
  shift
  echo "note: using x86_64 bazelisk"
  bazelisk_bin=bazelisk-darwin-amd64
fi

if [[ -n "${USE_BAZEL_VERSION:-}" ]]; then
  if command -v "$bazelisk_bin" > /dev/null; then
    exec "$bazelisk_bin" "$@"
  else
    echo "error: no $bazelisk_bin found"
    exit 1
  fi
fi

# TODO check root of git repo for this
if [[ -e ./bazelw ]]; then
  exec ./bazelw "$@"
fi

if command -v "$bazelisk_bin" > /dev/null; then
  exec "$bazelisk_bin" "$@"
fi

echo "error: no $bazelisk_bin found"
exit 1
