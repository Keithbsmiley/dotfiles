#!/usr/bin/env python

import netrc
import requests
import sys

ADD_URL = "https://api.pinboard.in/v1/posts/add"


def token(machine):
    n = netrc.netrc()
    auth = n.authenticators(machine)
    if auth is None:
        sys.exit("Add %s to your ~/.netrc" % machine)

    user = auth[0] or auth[1]
    password = auth[2]

    if user is None or password is None:
        sys.exit("Invalid netrc entry for %s" % machine)

    return "%s:%s" % (user, password)


def request_params(params={}):
    return dict({"format": "json",
                 "auth_token": token("pinboard.in")}.items() + params.items())


def usage(prg):
    print("Usage: %s URL" % prg)
    sys.exit(2)


def format_url(url):
    if url.find("://") == -1:
        return "https://%s" % url
    else:
        return url


def main(raw_url):
    url = format_url(raw_url)
    params = request_params({"url": url, "description": url, "toread": "yes"})
    r = requests.post(ADD_URL, params=params)
    json = r.json()
    if json["result_code"] != "done":
        print(json)
        sys.exit(1)


if __name__ == '__main__':
    if len(sys.argv) != 2:
        usage(sys.argv[0])
    try:
        url = str(sys.argv[1])
        main(url)
    except ValueError:
        usage(sys.argv[0])
