#!/usr/bin/env python
# A simple python script to open
# All Github pull request notifications
# On OS X

import netrc
import os
import requests
import sys

URL = "https://api.github.com/notifications"
NETRC_MACHINE = "api.github.com"


def credentials():
    n = netrc.netrc()
    auth = n.authenticators(NETRC_MACHINE)
    if auth is None:
        sys.exit("Add api.github.com to your ~/.netrc")

    user = auth[0] or auth[1]
    password = auth[2]

    if user is None or password is None:
        sys.exit("Invalid netrc entry for api.github.com")

    return user, password


def open_pull_requests():
    user, password = credentials()
    r = requests.get(URL, auth=(user, password))
    json = r.json()
    opened = False

    for blob in json:
        kind = blob["subject"]["type"]
        if kind != "PullRequest":
            continue

        pr_url = blob["subject"]["url"]
        r = requests.get(pr_url, auth=(user, password))
        html_url = r.json()["html_url"]
        os.system("open " + html_url)
        opened = True

    if not opened:
        sys.exit("No Unread Pull Requests")


open_pull_requests()
