#!/bin/bash
#
# Open $EDITOR (some vim variant) at the currently open line in Xcode
#

set -euo pipefail

# TODO: There are a few issues with this script:
# 1. I cannot find a way to get the _actual_ focused window in Xcode, just all
#    documents that are open in general, which is why it fuzzy finds.
# 2. If you have multiple Xcode versions open I don't understand how AppleScript
#    picks which one to use but it doesn't work, maybe I could find multiple open
#    ones and collect all the files from them
# 3. It would be nice if the paths were relativized to the pwd since my expected
#    use case is you'd execute this from the project's SRCROOT

read -r -d '' script <<EOF || true
var documents = Application("Xcode").sourceDocuments();
for (const documentIndex in documents) {
  var document = documents[documentIndex];
  console.log("PATH:" + document.path() + ":" + document.selectedCharacterRange.get());
}
EOF

all_output=$(mktemp)
if ! echo "$script" | osascript -l JavaScript > "$all_output" 2>&1; then
  echo "error: failed to fetch files: $(grep -v PATH: "$all_output")" >&2
  exit 1
fi

paths=$(grep PATH: "$all_output" || true)
if [[ -z "$paths" ]]; then
  echo "error: no open files in Xcode" >&2
  exit 1
fi

selected=$(echo "$paths" | cut -d: -f2 | fzy)
start_position=$(echo "$paths" | grep "^PATH:$selected:" | cut -d: -f3 | cut -d, -f1)
exec "$EDITOR" "$selected" "+call cursor(byte2line($start_position), $start_position - line2byte(byte2line($start_position)))"
